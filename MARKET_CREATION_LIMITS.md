# é¢„æµ‹å¸‚åœºåˆ›å»ºé™åˆ¶ç³»ç»Ÿ

## ğŸ“‹ ç³»ç»Ÿæ¦‚è§ˆ

ä¸ºäº†é˜²æ­¢åƒåœ¾é¢„æµ‹å†…å®¹å’Œæå‡é¢„æµ‹è´¨é‡ï¼Œç”¨æˆ·åˆ›å»ºé¢„æµ‹éœ€è¦æ»¡è¶³æ—¶é—´é—´éš”å’Œè´¹ç”¨è¦æ±‚ã€‚

---

## â° åˆ›å»ºé¢‘ç‡é™åˆ¶

### åŸºäºç­‰çº§çš„æ—¶é—´é—´éš”

| ç”¨æˆ·ç±»å‹ | ç§¯åˆ†èŒƒå›´ | ç­‰çº§ | åˆ›å»ºé—´éš” | è¯´æ˜ |
|---------|---------|------|---------|------|
| æ™®é€šç”¨æˆ· | - | æ— ç­‰çº§ | 360å°æ—¶ (15å¤©) | æœªæˆä¸ºé™ªå®¡å‘˜ |
| æ­¦æ—æ–°ä¸ | 0-99 | Lv.1 | 72å°æ—¶ (3å¤©) | åˆçº§é™ªå®¡å‘˜ |
| é£å°˜å¥‡ä¾  | 100-399 | Lv.2 | 48å°æ—¶ (2å¤©) | ä¸­çº§é™ªå®¡å‘˜ |
| åœ°ç‹±åˆ¤å®˜ | 400-999 | Lv.3 | 24å°æ—¶ (1å¤©) | é«˜çº§é™ªå®¡å‘˜ |
| å¤©ä¸Šå¤©ä¸‹å¤©åœ°æ— åŒ | 1000+ | Lv.4 | 6å°æ—¶ | é¡¶çº§é™ªå®¡å‘˜ |

### è®¾è®¡ç†å¿µ

**æ™®é€šç”¨æˆ·é™åˆ¶ä¸¥æ ¼**ï¼š
- 360å°æ—¶ï¼ˆ15å¤©ï¼‰çš„é—´éš”ç¡®ä¿åªæœ‰çœŸæ­£æƒ³åˆ›å»ºé«˜è´¨é‡é¢„æµ‹çš„ç”¨æˆ·æ‰ä¼šä»˜è´¹
- é˜²æ­¢åƒåœ¾é¢„æµ‹æ³›æ»¥

**é™ªå®¡å‘˜äº«å—ç‰¹æƒ**ï¼š
- æˆä¸ºé™ªå®¡å‘˜åï¼Œåˆ›å»ºé¢‘ç‡å¤§å¹…æå‡
- ç­‰çº§è¶Šé«˜ï¼Œåˆ›å»ºè¶Šé¢‘ç¹
- é¼“åŠ±ç”¨æˆ·æˆä¸ºé™ªå®¡å‘˜å¹¶ç§¯æå‚ä¸

**é¡¶çº§ç”¨æˆ·å‡ ä¹æ— é™åˆ¶**ï¼š
- 1000+ç§¯åˆ†çš„ç”¨æˆ·æ¯6å°æ—¶å¯åˆ›å»ºä¸€æ¬¡
- ä¸€å¤©æœ€å¤š4æ¬¡ï¼Œè¶³å¤Ÿæ´»è·ƒç”¨æˆ·ä½¿ç”¨

---

## ğŸ’° åˆ›å»ºè´¹ç”¨

### è´¹ç”¨æ„æˆ

```
æ€»è´¹ç”¨ = 100 TAI + TON Gas è´¹

å…¶ä¸­ï¼š
- 100 TAIï¼šå¹³å°åˆ›å»ºè´¹ï¼ˆè¿›å…¥ DAO å‚¨å¤‡æ± ï¼‰
- TON Gasï¼šé“¾ä¸Šåˆçº¦æ‰§è¡Œè´¹ç”¨ï¼ˆå®é™…æ¶ˆè€—ï¼‰
```

### è´¹ç”¨è¯´æ˜

**100 TAI åˆ›å»ºè´¹**ï¼š
- ç”¨é€”ï¼šè¿›å…¥ DAO å‚¨å¤‡æ± 
- ç›®çš„ï¼š
  1. é˜²æ­¢åƒåœ¾é¢„æµ‹ï¼ˆæé«˜åˆ›å»ºæˆæœ¬ï¼‰
  2. è¡¥å…… DAO å‚¨å¤‡é‡‘
  3. ç”¨äºå¥–åŠ±ä¼˜è´¨é¢„æµ‹åˆ›å»ºè€…

**TON Gas è´¹**ï¼š
- ç”¨é€”ï¼šæ”¯ä»˜é“¾ä¸Šåˆçº¦æ‰§è¡Œ
- é‡‘é¢ï¼šæ ¹æ®ç½‘ç»œæ‹¥å µåŠ¨æ€å˜åŒ–
- é¢„ä¼°ï¼š0.1-0.5 TON

### è´¹ç”¨æµå‘

```
ç”¨æˆ·æ”¯ä»˜ï¼š100 TAI + Gas
    â†“
100 TAI â†’ DAO å‚¨å¤‡æ± 
    â†“
ç”¨äºï¼š
- é™ªå®¡å‘˜å¥–åŠ±è¡¥å……
- ä¼˜è´¨é¢„æµ‹æ¿€åŠ±
- å¹³å°è¿è¥
```

---

## ğŸ”§ å®ç°é€»è¾‘

### 1. åˆ›å»ºé—´éš”è®¡ç®—

```typescript
function getCreateInterval(points: number, isJuror: boolean): number {
  // æ™®é€šç”¨æˆ·
  if (!isJuror) {
    return 360; // 360å°æ—¶ = 15å¤©
  }
  
  // é™ªå®¡å‘˜æ ¹æ®ç­‰çº§
  if (points >= 1000) return 6;   // 6å°æ—¶
  if (points >= 400) return 24;   // 24å°æ—¶
  if (points >= 100) return 48;   // 48å°æ—¶
  return 72;                      // 72å°æ—¶
}
```

### 2. åˆ›å»ºæƒé™æ£€æŸ¥

```typescript
interface CreatePermission {
  canCreate: boolean;
  reason?: string;
  nextAvailableTime?: Date;
  intervalHours: number;
  fee: {
    tai: number;
    estimatedGas: number;
  };
}

async function checkCreatePermission(userId: string): Promise<CreatePermission> {
  const user = await getUser(userId);
  const lastCreate = await getLastCreateTime(userId);
  
  // è·å–åˆ›å»ºé—´éš”
  const intervalHours = getCreateInterval(user.points, user.isJuror);
  
  // æ£€æŸ¥æ—¶é—´é—´éš”
  if (lastCreate) {
    const hoursSinceLastCreate = (Date.now() - lastCreate.getTime()) / (1000 * 60 * 60);
    
    if (hoursSinceLastCreate < intervalHours) {
      const nextAvailable = new Date(lastCreate.getTime() + intervalHours * 60 * 60 * 1000);
      return {
        canCreate: false,
        reason: `éœ€è¦ç­‰å¾… ${intervalHours} å°æ—¶åæ‰èƒ½åˆ›å»ºä¸‹ä¸€ä¸ªé¢„æµ‹`,
        nextAvailableTime: nextAvailable,
        intervalHours,
        fee: { tai: 100, estimatedGas: 0.3 }
      };
    }
  }
  
  // æ£€æŸ¥ä½™é¢
  if (user.balance < 100) {
    return {
      canCreate: false,
      reason: 'ä½™é¢ä¸è¶³ï¼Œéœ€è¦è‡³å°‘ 100 TAI',
      intervalHours,
      fee: { tai: 100, estimatedGas: 0.3 }
    };
  }
  
  return {
    canCreate: true,
    intervalHours,
    fee: { tai: 100, estimatedGas: 0.3 }
  };
}
```


### 3. åˆ›å»ºæµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"åˆ›å»ºé¢„æµ‹"
   â†“
2. ç³»ç»Ÿæ£€æŸ¥åˆ›å»ºæƒé™
   - æ£€æŸ¥æ—¶é—´é—´éš”
   - æ£€æŸ¥ä½™é¢
   â†“
3. æ˜¾ç¤ºåˆ›å»ºè¡¨å•
   - æ˜¾ç¤ºéœ€è¦æ”¯ä»˜çš„è´¹ç”¨
   - æ˜¾ç¤ºä¸‹æ¬¡å¯åˆ›å»ºæ—¶é—´
   â†“
4. ç”¨æˆ·å¡«å†™é¢„æµ‹ä¿¡æ¯
   â†“
5. ç”¨æˆ·ç¡®è®¤å¹¶æ”¯ä»˜
   - æ‰£é™¤ 100 TAI
   - ç­¾å TON äº¤æ˜“ï¼ˆGasè´¹ï¼‰
   â†“
6. åˆ›å»ºæˆåŠŸ
   - è®°å½•åˆ›å»ºæ—¶é—´
   - é¢„æµ‹ä¸Šé“¾
   - 100 TAI è¿›å…¥ DAO å‚¨å¤‡æ± 
```

---

## ğŸ¨ UI è®¾è®¡

### åˆ›å»ºæŒ‰é’®çŠ¶æ€

#### å¯ä»¥åˆ›å»º
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [+] åˆ›å»ºé¢„æµ‹                        â”‚
â”‚                                      â”‚
â”‚  è´¹ç”¨ï¼š100 TAI + ~0.3 TON Gas       â”‚
â”‚  ä½ çš„ç­‰çº§ï¼šé£å°˜å¥‡ä¾  (Lv.2)           â”‚
â”‚  åˆ›å»ºé—´éš”ï¼š48å°æ—¶                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å†·å´ä¸­
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â°] åˆ›å»ºé¢„æµ‹ï¼ˆå†·å´ä¸­ï¼‰             â”‚
â”‚                                      â”‚
â”‚  ä¸‹æ¬¡å¯åˆ›å»ºï¼š23å°æ—¶å                â”‚
â”‚  (2024-11-04 14:30)                 â”‚
â”‚                                      â”‚
â”‚  æç¤ºï¼šå‡çº§åˆ°åœ°ç‹±åˆ¤å®˜å¯ç¼©çŸ­è‡³24å°æ—¶  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä½™é¢ä¸è¶³
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ğŸ’°] åˆ›å»ºé¢„æµ‹ï¼ˆä½™é¢ä¸è¶³ï¼‰           â”‚
â”‚                                      â”‚
â”‚  éœ€è¦ï¼š100 TAI                       â”‚
â”‚  å½“å‰ï¼š45 TAI                        â”‚
â”‚  è¿˜éœ€ï¼š55 TAI                        â”‚
â”‚                                      â”‚
â”‚  [å……å€¼]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ›å»ºè¡¨å•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºé¢„æµ‹                            [å…³é—­]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  é¢„æµ‹æ ‡é¢˜ï¼š*                                 â”‚
â”‚  [è¾“å…¥æ¡†]                                    â”‚
â”‚                                              â”‚
â”‚  é¢„æµ‹æè¿°ï¼š*                                 â”‚
â”‚  [æ–‡æœ¬æ¡†]                                    â”‚
â”‚                                              â”‚
â”‚  é€‰é¡¹ Aï¼š*                                   â”‚
â”‚  [è¾“å…¥æ¡†]                                    â”‚
â”‚                                              â”‚
â”‚  é€‰é¡¹ Bï¼š*                                   â”‚
â”‚  [è¾“å…¥æ¡†]                                    â”‚
â”‚                                              â”‚
â”‚  ç»“æŸæ—¶é—´ï¼š*                                 â”‚
â”‚  [æ—¥æœŸé€‰æ‹©å™¨]                                â”‚
â”‚                                              â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚                                              â”‚
â”‚  è´¹ç”¨æ˜ç»†ï¼š                                  â”‚
â”‚  â€¢ åˆ›å»ºè´¹ï¼š100 TAI                          â”‚
â”‚  â€¢ Gas è´¹ï¼š~0.3 TON                         â”‚
â”‚                                              â”‚
â”‚  ä½ çš„ä½™é¢ï¼š                                  â”‚
â”‚  â€¢ TAIï¼š1,234 âœ…                            â”‚
â”‚  â€¢ TONï¼š5.6 âœ…                              â”‚
â”‚                                              â”‚
â”‚  åˆ›å»ºé—´éš”ï¼š48å°æ—¶                            â”‚
â”‚  ä¸‹æ¬¡å¯åˆ›å»ºï¼š2024-11-06 14:30               â”‚
â”‚                                              â”‚
â”‚  [å–æ¶ˆ] [ç¡®è®¤åˆ›å»ºå¹¶æ”¯ä»˜]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### æ›´æ–° users è¡¨

```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS
  last_market_created_at TIMESTAMP, -- æœ€ååˆ›å»ºé¢„æµ‹æ—¶é—´
  total_markets_created INTEGER DEFAULT 0; -- æ€»åˆ›å»ºæ•°

CREATE INDEX idx_users_last_market_created ON users(last_market_created_at);
```

### æ›´æ–° markets è¡¨

```sql
ALTER TABLE markets ADD COLUMN IF NOT EXISTS
  creation_fee BIGINT DEFAULT 100, -- åˆ›å»ºè´¹ç”¨ï¼ˆTAIï¼‰
  creation_tx_hash TEXT; -- åˆ›å»ºäº¤æ˜“å“ˆå¸Œ

CREATE INDEX idx_markets_creator_id ON markets(creator_id);
CREATE INDEX idx_markets_created_at ON markets(created_at);
```

---

## ğŸ”§ API è®¾è®¡

### GET /api/market/create-permission
æ£€æŸ¥åˆ›å»ºæƒé™

```typescript
Request: {
  userId: string;
}

Response: {
  canCreate: boolean;
  reason?: string;
  nextAvailableTime?: string;
  intervalHours: number;
  userLevel: {
    level: number;
    name: string;
    points: number;
  };
  fee: {
    tai: number;
    estimatedGas: number;
  };
  balance: {
    tai: number;
    ton: number;
  };
}
```

### POST /api/market/create
åˆ›å»ºé¢„æµ‹

```typescript
Request: {
  userId: string;
  title: string;
  description: string;
  optionA: string;
  optionB: string;
  endTime: string;
  paymentTxHash: string; // 100 TAI æ”¯ä»˜äº¤æ˜“
  gasTxHash: string;     // TON Gas äº¤æ˜“
}

Response: {
  success: boolean;
  marketId: string;
  message: string;
  nextAvailableTime: string;
}
```

---

## ğŸ’¡ ä¼˜åŠ¿åˆ†æ

### 1. é˜²æ­¢åƒåœ¾é¢„æµ‹ âœ…
- 360å°æ—¶é—´éš” + 100 TAI è´¹ç”¨ = é«˜é—¨æ§›
- åªæœ‰è®¤çœŸçš„ç”¨æˆ·æ‰ä¼šåˆ›å»º

### 2. æå‡å†…å®¹è´¨é‡ âœ…
- ç”¨æˆ·ä¼šæ›´è°¨æ…åœ°è®¾è®¡é¢„æµ‹
- é¿å…éšæ„åˆ›å»ºä½è´¨é‡å†…å®¹

### 3. é¼“åŠ±æˆä¸ºé™ªå®¡å‘˜ âœ…
- é™ªå®¡å‘˜äº«å—æ›´çŸ­çš„åˆ›å»ºé—´éš”
- ç­‰çº§è¶Šé«˜ï¼Œç‰¹æƒè¶Šå¤š

### 4. ç»æµå¹³è¡¡ âœ…
- 100 TAI è¿›å…¥ DAO å‚¨å¤‡æ± 
- è¡¥å……é™ªå®¡å‘˜å¥–åŠ±
- å½¢æˆè‰¯æ€§å¾ªç¯

### 5. é˜²æ­¢åˆ·é‡ âœ…
- æ—¶é—´é—´éš”é™åˆ¶
- è´¹ç”¨æˆæœ¬
- åŒé‡ä¿æŠ¤

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### æ™®é€šç”¨æˆ·
```
åˆ›å»ºæˆæœ¬ï¼š100 TAI + Gas
åˆ›å»ºé¢‘ç‡ï¼š15å¤©/æ¬¡
å¹´åº¦åˆ›å»ºï¼š~24æ¬¡

é€‚åˆï¼š
- å¶å°”åˆ›å»ºé«˜è´¨é‡é¢„æµ‹çš„ç”¨æˆ·
- æƒ³è¦å°è¯•åˆ›å»ºåŠŸèƒ½çš„æ–°ç”¨æˆ·
```

### é™ªå®¡å‘˜ï¼ˆLv.2ï¼‰
```
åˆ›å»ºæˆæœ¬ï¼š100 TAI + Gas
åˆ›å»ºé¢‘ç‡ï¼š2å¤©/æ¬¡
å¹´åº¦åˆ›å»ºï¼š~180æ¬¡

é€‚åˆï¼š
- æ´»è·ƒçš„é¢„æµ‹åˆ›å»ºè€…
- æœ‰ä¸€å®šç»éªŒçš„ç”¨æˆ·
```

### é¡¶çº§é™ªå®¡å‘˜ï¼ˆLv.4ï¼‰
```
åˆ›å»ºæˆæœ¬ï¼š100 TAI + Gas
åˆ›å»ºé¢‘ç‡ï¼š6å°æ—¶/æ¬¡
å¹´åº¦åˆ›å»ºï¼š~1,460æ¬¡

é€‚åˆï¼š
- ä¸“ä¸šé¢„æµ‹åˆ›å»ºè€…
- é«˜åº¦æ´»è·ƒç”¨æˆ·
- å†…å®¹è´¡çŒ®è€…
```

---

## ğŸ†• 2025-11 æ›´æ–°

- âœ… `predictions.juror_reward_tai` å­—æ®µå·²ä¸Šçº¿ï¼Œç¡®ä¿é™ªå®¡å¥–åŠ±å…¥åº“
- âœ… `users` è¡¨æ–°å¢ `dao_points`ã€`last_market_created_at`ã€`total_creation_fee_tai`
- âœ… `POST /api/markets` æœåŠ¡ç«¯æ ¡éªŒå†·å´æ—¶é—´ã€å¥–åŠ±åŒºé—´å¹¶è®°è´¦ DAO æ± 
- âœ… æ–°å¢ `GET /api/markets/creation/permission` æä¾›é¢åº¦æŸ¥è¯¢
- âœ… å‰ç«¯åˆ›å»ºè¡¨å•å±•ç¤ºå†·å´çŠ¶æ€ã€å¥–åŠ±åŒºé—´ä¸è´¹ç”¨æç¤º
- âš ï¸ å°† `ENFORCE_CREATION_BALANCE` è®¾ä¸º `true` æ–¹å¯å¼ºåˆ¶æ‰£å‡ `user_balances`

## ğŸ¯ å®æ–½ä¼˜å…ˆçº§

### Phase 1: åŸºç¡€é™åˆ¶ï¼ˆ1å‘¨ï¼‰
- [x] å®ç°æ—¶é—´é—´éš”æ£€æŸ¥
- [x] å®ç°è´¹ç”¨æ‰£é™¤
- [x] æ›´æ–°åˆ›å»ºè¡¨å•
- [x] æ·»åŠ æƒé™æ£€æŸ¥ API

### Phase 2: UI ä¼˜åŒ–ï¼ˆ3å¤©ï¼‰
- [x] åˆ›å»ºæŒ‰é’®çŠ¶æ€æ˜¾ç¤º
- [x] å†·å´å€’è®¡æ—¶
- [x] è´¹ç”¨æ˜ç»†å±•ç¤º
- [x] ä½™é¢æ£€æŸ¥æç¤º

### Phase 3: æ•°æ®ç»Ÿè®¡ï¼ˆ2å¤©ï¼‰
- [ ] åˆ›å»ºå†å²è®°å½•
- [ ] åˆ›å»ºé¢‘ç‡ç»Ÿè®¡
- [ ] è´¹ç”¨ç»Ÿè®¡
- [ ] ç”¨æˆ·åˆ›å»ºæ’è¡Œ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.1  
**åˆ›å»ºæ—¶é—´**ï¼š2025-11-03  
**æœ€è¿‘æ›´æ–°**ï¼š2025-11-20  
**çŠ¶æ€**ï¼šåç«¯ä¸å‰ç«¯é™åˆ¶å·²è½åœ°ï¼Œç»Ÿè®¡çœ‹æ¿æ’æœŸä¸­
