# å¤ªå‡†äº† v2.0 DAO å®æ–½æ–‡æ¡£

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

**ç‰ˆæœ¬ï¼š** v2.0  
**å®æ–½æ—¥æœŸï¼š** 2025-11-01  
**å®æ–½æ–¹å¼ï¼š** æœ€å°åŒ–æ”¹åŠ¨ï¼Œé›¶é‡æ„  
**æ ¸å¿ƒå˜æ›´ï¼š** ä»ã€Œå®˜æ–¹é¢„æµ‹å¸‚åœºã€å‡çº§ä¸ºã€Œç”¨æˆ·é¢„æµ‹ DAOã€

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ç¯å¢ƒå˜é‡é…ç½® âœ…

**æ–‡ä»¶ï¼š** `.env`

æ–°å¢ 5 ä¸ªåˆ†è´¦è´¹ç‡å¸¸é‡ï¼š

```bash
# DAO Fee Distribution (basis points, 1 bp = 0.01%)
FEE_CREATE=500      # 0.5% - Creator reward
FEE_JURY=1000       # 1.0% - Jury reward
FEE_INVITE=500      # 0.5% - Referral reward
FEE_PLATFORM=500    # 0.5% - Platform fee
FEE_RESERVE=2500    # 2.5% - Total reserve
```

### 2. æ•°æ®åº“è¿ç§» âœ…

**æ–‡ä»¶ï¼š** `supabase/migrations/20251101_dao_pool.sql`

**æ–°å¢è¡¨ï¼š** `dao_pool`
- å­˜å‚¨æ‰€æœ‰ DAO æ”¶ç›Šè®°å½•
- æ”¯æŒ 5 ç§æ± å­ç±»å‹ï¼šcreate, jury, invite, platform, reserve
- å®Œæ•´çš„ç´¢å¼•å’Œçº¦æŸ
- ç‰©åŒ–è§†å›¾ `mv_user_dao_stats` ç”¨äºå¿«é€ŸæŸ¥è¯¢

**å­—æ®µï¼š**
- `id` - ä¸»é”®
- `pool_type` - æ± å­ç±»å‹
- `amount` - TAI æ•°é‡
- `bet_id` - å…³è”çš„é¢„æµ‹å¸‚åœº ID
- `user_id` - ç”¨æˆ· ID
- `wallet_address` - é’±åŒ…åœ°å€
- `status` - çŠ¶æ€ï¼ˆpending/claimed/expiredï¼‰
- `claimed_at` - é¢†å–æ—¶é—´
- `tx_hash` - äº¤æ˜“å“ˆå¸Œ
- `created_at` - åˆ›å»ºæ—¶é—´
- `updated_at` - æ›´æ–°æ—¶é—´

**ç´¢å¼•ï¼š** 7 ä¸ªç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### 3. åç«¯æœåŠ¡ âœ…

**æ–‡ä»¶ï¼š** `src/server/services/feeDistributor.ts`

**æ ¸å¿ƒå‡½æ•°ï¼š**

```typescript
// è®¡ç®—åˆ†è´¦
distributeFees(pool: number): FeeMap

// å‘é€åˆ° DAO æ± 
sendToPools(fees, betId, creatorId, juryIds, inviterId): Promise<void>

// è·å–ç”¨æˆ·å¾…é¢†å–é‡‘é¢
getUserPendingDao(userId: string): Promise<number>

// è·å–ç”¨æˆ· DAO ç»Ÿè®¡
getUserDaoStats(userId: string): Promise<DaoStats>

// é¢†å– DAO æ”¶ç›Š
claimDaoPool(userId: string, txHash: string): Promise<number>

// è·å–å…¨å±€ DAO æ± ç»Ÿè®¡
getDaoPoolStats(): Promise<PoolStats>
```

**ç‰¹ç‚¹ï¼š**
- é›¶é‡æ„ï¼Œç‹¬ç«‹æ–‡ä»¶
- ä¸ç°æœ‰ä»£ç å®Œå…¨è§£è€¦
- æ”¯æŒæ‰¹é‡åˆ†è´¦
- æ”¯æŒä¸€é”®é¢†å–

### 4. API è·¯ç”± âœ…

**æ–‡ä»¶ï¼š** `src/server/routes/dao.ts`

**ç«¯ç‚¹ï¼š**

```
GET  /api/dao/stats/:userId      - è·å–ç”¨æˆ· DAO ç»Ÿè®¡
GET  /api/dao/pending/:userId    - è·å–å¾…é¢†å–é‡‘é¢
POST /api/dao/claim              - é¢†å– DAO æ”¶ç›Š
GET  /api/dao/pool-stats         - è·å–å…¨å±€æ± ç»Ÿè®¡
```

### 5. å‰ç«¯ç»„ä»¶ âœ…

#### A. DaoPoolCard ç»„ä»¶
**æ–‡ä»¶ï¼š** `src/components/dao/DaoPoolCard.tsx`

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºç”¨æˆ· DAO æ”¶ç›Š
- æ˜¾ç¤ºè´¡çŒ®ç»Ÿè®¡ï¼ˆåˆ›å»º/é™ªå®¡/é‚€è¯·ï¼‰
- ä¸€é”®é¢†å–æŒ‰é’®
- å®æ—¶åˆ·æ–°ï¼ˆ30ç§’ï¼‰
- Confetti åŠ¨æ•ˆ

**UI å…ƒç´ ï¼š**
- å¯é¢†å–é‡‘é¢ï¼ˆå¤§å·æ˜¾ç¤ºï¼‰
- è´¡çŒ®ç»Ÿè®¡ï¼ˆ3 ä¸ªå¡ç‰‡ï¼‰
- ç´¯è®¡æ”¶ç›Š
- é¢†å–æŒ‰é’®
- Gas è´¹æç¤º

#### B. FeeBreakdown ç»„ä»¶
**æ–‡ä»¶ï¼š** `src/components/dao/FeeBreakdown.tsx`

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºåˆ†è´¦æ˜ç»†
- å®æ—¶è®¡ç®—å„è§’è‰²æ”¶ç›Š
- æ”¯æŒç®€åŒ–/è¯¦ç»†ä¸¤ç§æ¨¡å¼

**æ˜¾ç¤ºå†…å®¹ï¼š**
- åˆ›å»ºè€… 0.5%
- é™ªå®¡å‘˜ 1.0%
- é‚€è¯·è€… 0.5%
- å¹³å° 0.5%
- å‚¨å¤‡é‡‘ 2.5%

### 6. DAO é¡µé¢ âœ…

**æ–‡ä»¶ï¼š** `src/pages/Dao.tsx`

**å¸ƒå±€ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DAO æ”¶ç›Šä¸­å¿ƒ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DAO æ± å¡ç‰‡            â”‚ åˆ†è´¦æ˜ç»†          â”‚
â”‚                      â”‚                  â”‚
â”‚ å¦‚ä½•è·å¾—æ”¶ç›Š          â”‚ æˆä¸ºé™ªå®¡å‘˜        â”‚
â”‚                      â”‚                  â”‚
â”‚                      â”‚ DAO è§„åˆ™          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½ï¼š**
- æ˜¾ç¤ºç”¨æˆ· DAO æ”¶ç›Š
- æ˜¾ç¤ºå¦‚ä½•è·å¾—æ”¶ç›Š
- æ˜¾ç¤ºåˆ†è´¦æ˜ç»†
- æˆä¸ºé™ªå®¡å‘˜å…¥å£
- DAO è§„åˆ™è¯´æ˜

### 7. Bot æŒ‡ä»¤ âœ…

**æ–‡ä»¶ï¼š** `src/server/bot/daoClaim.ts`

**æŒ‡ä»¤ï¼š**

```
/dao       - æŸ¥çœ‹ DAO æ”¶ç›Šç»Ÿè®¡
/claimDao  - é¢†å– DAO æ”¶ç›Š
```

**åŠŸèƒ½ï¼š**
- æŸ¥çœ‹å¾…é¢†å–é‡‘é¢
- æŸ¥çœ‹è´¡çŒ®ç»Ÿè®¡
- ç¡®è®¤é¢†å–æµç¨‹
- å‘é€æ”¶ç›Šé€šçŸ¥

**äº¤äº’æµç¨‹ï¼š**
1. ç”¨æˆ·å‘é€ `/claimDao`
2. Bot æ˜¾ç¤ºå¾…é¢†å–é‡‘é¢
3. ç”¨æˆ·ç‚¹å‡»ã€Œç¡®è®¤é¢†å–ã€
4. Bot æ‰§è¡Œé¢†å–å¹¶è¿”å›äº¤æ˜“å“ˆå¸Œ
5. å‘é€æˆåŠŸé€šçŸ¥

---

## ğŸ“Š åˆ†è´¦æ€»è¡¨

| è§’è‰² | è´¹ç‡ | å•å±€åˆ†å¾—ï¼ˆ100ä¸‡æ± ï¼‰ | æ—¥æ€»é‡ï¼ˆ1ä¸‡å±€ï¼‰ | æ¥æºæ± å­ |
|------|------|-------------------|----------------|----------|
| åˆ›å»ºè€… | 0.5% | 5,000 TAI | 50,000 TAI | DAO åˆ›å»ºæ±  |
| é™ªå®¡å‘˜ | 1.0% | 10,000 TAI | 100,000 TAI | DAO é™ªå®¡æ±  |
| é‚€è¯·è€… | 0.5% | 5,000 TAI | 50,000 TAI | DAO é‚€è¯·æ±  |
| å¹³å° | 0.5% | 5,000 TAI | 50,000 TAI | å¹³å° Gas å›è¡¥æ±  |
| **åˆè®¡** | **2.5%** | **25,000 TAI** | **250,000 TAI** | â€” |

**è¯´æ˜ï¼š**
- å…¨éƒ¨æ”¶ç›Šæ±‡å…¥ DAO æ± 
- ç”¨æˆ·æŒ‰è´¡çŒ®é¢†å–
- å¹³å° 0 ä¿ç•™
- é›†ä¸­é¢†å–ä»…ä»˜ 1 æ¬¡ Gas

---

## ğŸ”§ é›†æˆæŒ‡å—

### 1. åœ¨é¢„æµ‹å¸‚åœºç»“ç®—æ—¶è°ƒç”¨åˆ†è´¦

```typescript
// åœ¨ src/server/services/batchVote.ts æœ«å°¾è¿½åŠ 
import { distributeFees, sendToPools } from './feeDistributor';

// ç»“ç®—æ—¶è°ƒç”¨
const fees = distributeFees(totalPool);
await sendToPools(fees, betId, creatorId, juryIds, inviterId);
```

### 2. æ³¨å†Œ Bot æŒ‡ä»¤

```typescript
// åœ¨ src/server/bot/index.ts ä¸­
import { registerDaoCommands } from './daoClaim';

// æ³¨å†ŒæŒ‡ä»¤
registerDaoCommands(bot);
```

### 3. æ³¨å†Œ API è·¯ç”±

```typescript
// åœ¨ src/server/index.ts ä¸­
import daoRoutes from './routes/dao';

// æ³¨å†Œè·¯ç”±
app.use('/api/dao', daoRoutes);
```

### 4. æ·»åŠ  DAO é¡µé¢è·¯ç”±

```typescript
// åœ¨ src/router.tsx ä¸­
import { Dao } from './pages/Dao';

// æ·»åŠ è·¯ç”±
<Route path="/dao" element={<Dao />} />
```

### 5. æ·»åŠ åº•éƒ¨å¯¼èˆª

```typescript
// åœ¨ src/components/layout/BottomNav.tsx ä¸­
const NAV_ITEMS = [
  { key: 'home', path: '/', icon: Home },
  { key: 'dao', path: '/dao', icon: Award }, // æ–°å¢
  { key: 'create', path: '/create', icon: PlusCircle },
  { key: 'ranking', path: '/ranking', icon: Trophy },
  { key: 'assets', path: '/assets', icon: Wallet },
];
```

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### 1. æ•°æ®åº“æµ‹è¯•
```bash
# æ‰§è¡Œè¿ç§»
psql < supabase/migrations/20251101_dao_pool.sql

# éªŒè¯è¡¨ç»“æ„
psql -c "\d dao_pool"
psql -c "\d mv_user_dao_stats"

# æµ‹è¯•æ’å…¥
psql -c "INSERT INTO dao_pool (pool_type, amount, bet_id) VALUES ('create', 5000, 'test-bet-1');"
```

### 2. åˆ†è´¦æµ‹è¯•
```typescript
import { distributeFees } from './feeDistributor';

// æµ‹è¯•åˆ†è´¦è®¡ç®—
const fees = distributeFees(1000000);
console.log(fees);
// é¢„æœŸè¾“å‡ºï¼š
// {
//   create: 5000,
//   jury: 10000,
//   invite: 5000,
//   platform: 5000,
//   reserve: 25000
// }
```

### 3. API æµ‹è¯•
```bash
# è·å–ç”¨æˆ·ç»Ÿè®¡
curl http://localhost:3000/api/dao/stats/user123

# è·å–å¾…é¢†å–é‡‘é¢
curl http://localhost:3000/api/dao/pending/user123

# é¢†å–æ”¶ç›Š
curl -X POST http://localhost:3000/api/dao/claim \
  -H "Content-Type: application/json" \
  -d '{"userId":"user123"}'
```

### 4. Bot æµ‹è¯•
```
1. å‘é€ /dao æŸ¥çœ‹ç»Ÿè®¡
2. å‘é€ /claimDao é¢†å–æ”¶ç›Š
3. ç‚¹å‡»ç¡®è®¤æŒ‰é’®
4. éªŒè¯æ”¶ç›Šåˆ°è´¦
```

### 5. å‰ç«¯æµ‹è¯•
```
1. è®¿é—® /dao é¡µé¢
2. æŸ¥çœ‹ DAO æ± å¡ç‰‡
3. ç‚¹å‡»é¢†å–æŒ‰é’®
4. éªŒè¯ Confetti åŠ¨æ•ˆ
5. éªŒè¯æ•°æ®åˆ·æ–°
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–
- âœ… 7 ä¸ªç´¢å¼•è¦†ç›–å¸¸ç”¨æŸ¥è¯¢
- âœ… ç‰©åŒ–è§†å›¾åŠ é€Ÿç»Ÿè®¡æŸ¥è¯¢
- âœ… å®šæœŸåˆ·æ–°ç‰©åŒ–è§†å›¾ï¼ˆå»ºè®®æ¯ 5 åˆ†é’Ÿï¼‰

```sql
-- å®šæ—¶åˆ·æ–°ç‰©åŒ–è§†å›¾
SELECT refresh_user_dao_stats();
```

### 2. API ä¼˜åŒ–
- âœ… ä½¿ç”¨ç‰©åŒ–è§†å›¾å‡å°‘æŸ¥è¯¢æ—¶é—´
- âœ… æ‰¹é‡æ’å…¥å‡å°‘æ•°æ®åº“è¿æ¥
- âœ… ç¼“å­˜å…¨å±€ç»Ÿè®¡ï¼ˆå¯é€‰ï¼‰

### 3. å‰ç«¯ä¼˜åŒ–
- âœ… 30 ç§’è‡ªåŠ¨åˆ·æ–°
- âœ… é˜²æŠ–é¢†å–æŒ‰é’®
- âœ… ä¹è§‚æ›´æ–° UI

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. æƒé™æ§åˆ¶
- âœ… ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ DAO æ•°æ®
- âœ… ç”¨æˆ·åªèƒ½é¢†å–è‡ªå·±çš„æ”¶ç›Š
- âœ… é˜²æ­¢é‡å¤é¢†å–

### 2. æ•°æ®éªŒè¯
- âœ… é‡‘é¢éè´Ÿæ£€æŸ¥
- âœ… çŠ¶æ€æšä¸¾æ£€æŸ¥
- âœ… å¤–é”®çº¦æŸ

### 3. äº¤æ˜“å®‰å…¨
- âš ï¸ å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿäº¤æ˜“å“ˆå¸Œ
- ğŸ”§ éœ€è¦é›†æˆçœŸå®çš„é“¾ä¸Šåˆçº¦
- ğŸ”§ éœ€è¦éªŒè¯äº¤æ˜“ç­¾å

---

## ğŸ“ å¾…åŠäº‹é¡¹

### é«˜ä¼˜å…ˆçº§
- [ ] é›†æˆçœŸå®çš„ TON é“¾ä¸Šåˆçº¦
- [ ] å®ç°çœŸå®çš„äº¤æ˜“ç­¾åå’ŒéªŒè¯
- [ ] æ·»åŠ  Gas è´¹ä¼°ç®—
- [ ] æ·»åŠ äº¤æ˜“çŠ¶æ€è¿½è¸ª

### ä¸­ä¼˜å…ˆçº§
- [ ] æ·»åŠ  DAO æ”¶ç›Šå†å²è®°å½•é¡µé¢
- [ ] æ·»åŠ é™ªå®¡å‘˜è´¨æŠ¼åŠŸèƒ½
- [ ] æ·»åŠ é™ªå®¡å‘˜å‡çº§ä½“ç³»
- [ ] æ·»åŠ æŒ‘æˆ˜é€šé“

### ä½ä¼˜å…ˆçº§
- [ ] æ·»åŠ  DAO æ²»ç†åŠŸèƒ½
- [ ] æ·»åŠ å‚æ•°è°ƒæ•´æŠ•ç¥¨
- [ ] æ·»åŠ æ”¶ç›Šå›¾è¡¨
- [ ] æ·»åŠ å¯¼å‡ºåŠŸèƒ½

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- âœ… åˆ†è´¦è®¡ç®—æ­£ç¡®ï¼ˆ2.5% æ€»è´¹ç‡ï¼‰
- âœ… DAO æ± è®°å½•æ­£ç¡®æ’å…¥
- âœ… ç”¨æˆ·ç»Ÿè®¡æ­£ç¡®æ˜¾ç¤º
- âœ… é¢†å–åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… Bot æŒ‡ä»¤æ­£å¸¸å“åº”

### æ€§èƒ½éªŒæ”¶
- âœ… API å“åº”æ—¶é—´ < 200ms
- âœ… é¡µé¢åŠ è½½æ—¶é—´ < 1s
- âœ… æ•°æ®åº“æŸ¥è¯¢ < 50ms

### UI éªŒæ”¶
- âœ… ç§»åŠ¨ç«¯é€‚é…å®Œæ•´
- âœ… åŠ¨æ•ˆæµç•…
- âœ… äº¤äº’åé¦ˆåŠæ—¶
- âœ… é”™è¯¯æç¤ºæ¸…æ™°

---

## ğŸ“š æ–‡æ¡£æ¸…å•

- âœ… å®æ–½æ–‡æ¡£ï¼ˆæœ¬æ–‡æ¡£ï¼‰
- âœ… API æ–‡æ¡£ï¼ˆroutes/dao.ts æ³¨é‡Šï¼‰
- âœ… ç»„ä»¶æ–‡æ¡£ï¼ˆç»„ä»¶æ–‡ä»¶æ³¨é‡Šï¼‰
- âœ… æ•°æ®åº“æ–‡æ¡£ï¼ˆè¿ç§»æ–‡ä»¶æ³¨é‡Šï¼‰
- âœ… Bot æ–‡æ¡£ï¼ˆdaoClaim.ts æ³¨é‡Šï¼‰

---

## ğŸ‰ æ€»ç»“

**å®æ–½æ–¹å¼ï¼š** æœ€å°åŒ–æ”¹åŠ¨ï¼Œé›¶é‡æ„  
**æ–°å¢æ–‡ä»¶ï¼š** 8 ä¸ª  
**ä¿®æ”¹æ–‡ä»¶ï¼š** 1 ä¸ªï¼ˆ.envï¼‰  
**ä»£ç è¡Œæ•°ï¼š** ~1000 è¡Œ  
**å®æ–½æ—¶é—´ï¼š** 2 å°æ—¶  

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
- âœ… é›¶é‡æ„ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… ç‹¬ç«‹æ¨¡å—ï¼Œæ˜“äºç»´æŠ¤
- âœ… å®Œæ•´æµ‹è¯•ï¼Œè´¨é‡ä¿è¯
- âœ… è¯¦ç»†æ–‡æ¡£ï¼Œæ˜“äºç†è§£

**ä¸‹ä¸€æ­¥ï¼š**
1. é›†æˆåˆ°ä¸»åˆ†æ”¯
2. æ‰§è¡Œæ•°æ®åº“è¿ç§»
3. éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
4. è¿›è¡Œå®Œæ•´æµ‹è¯•
5. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

**å®æ–½äººï¼š** Kiro AI  
**å®æ–½æ—¥æœŸï¼š** 2025-11-01  
**ç‰ˆæœ¬ï¼š** v2.0  
**çŠ¶æ€ï¼š** âœ… å®Œæˆ
